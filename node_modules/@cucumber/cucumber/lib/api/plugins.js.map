{"version":3,"file":"plugins.js","sourceRoot":"","sources":["../../src/api/plugins.ts"],"names":[],"mappings":";;;;;AAqDA,4DAQC;AAED,4DAKC;AAED,4DAmCC;AAzGD,uCAAwC;AACxC,0DAA4B;AAE5B,uDAAoC;AACpC,sCAAiD;AACjD,yDAAsC;AACtC,2DAAwC;AACxC,oDAAmD;AAGnD,KAAK,UAAU,YAAY,CAAC,SAAiB,EAAE,GAAW;IACxD,IAAI,CAAC;QACH,IAAI,UAAU,GAAiB,SAAS,CAAA;QACxC,IAAI,SAAS,CAAC,UAAU,CAAC,GAAG,CAAC,EAAE,CAAC;YAC9B,UAAU,GAAG,IAAA,wBAAa,EAAC,mBAAI,CAAC,OAAO,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC,CAAA;QAC1D,CAAC;aAAM,IAAI,SAAS,CAAC,UAAU,CAAC,SAAS,CAAC,EAAE,CAAC;YAC3C,UAAU,GAAG,IAAI,GAAG,CAAC,SAAS,CAAC,CAAA;QACjC,CAAC;QACD,OAAO,MAAM,MAAM,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,CAAA;IAC5C,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACX,MAAM,IAAI,KAAK,CAAC,2BAA2B,SAAS,EAAE,EAAE;YACtD,KAAK,EAAE,CAAC;SACT,CAAC,CAAA;IACJ,CAAC;AACH,CAAC;AAED,SAAS,UAAU,CAAC,QAAa;IAC/B,OAAO,mBAAmB,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAA;AACzC,CAAC;AAED,SAAS,mBAAmB,CAAC,KAAU,EAAE,KAAa;IACpD,IAAI,IAAA,gCAAgB,EAAC,KAAK,CAAC,EAAE,CAAC;QAC5B,OAAO,IAAI,CAAA;IACb,CAAC;IACD,IAAI,OAAO,KAAK,KAAK,QAAQ,IAAI,KAAK,CAAC,IAAI,KAAK,QAAQ,EAAE,CAAC;QACzD,OAAO,KAAK,CAAA;IACd,CAAC;IACD,KAAK,EAAE,CAAA;IACP,IAAI,KAAK,GAAG,CAAC,EAAE,CAAC;QACd,OAAO,mBAAmB,CAAC,KAAK,CAAC,OAAO,EAAE,KAAK,CAAC,CAAA;IAClD,CAAC;IACD,OAAO,IAAI,CAAA;AACb,CAAC;AAED,KAAK,UAAU,UAAU,CAAC,SAAiB,EAAE,GAAW;IACtD,MAAM,QAAQ,GAAG,MAAM,YAAY,CAAC,SAAS,EAAE,GAAG,CAAC,CAAA;IACnD,MAAM,KAAK,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAA;IAClC,IAAI,CAAC,KAAK,EAAE,CAAC;QACX,MAAM,IAAI,KAAK,CAAC,GAAG,SAAS,2BAA2B,CAAC,CAAA;IAC1D,CAAC;IACD,OAAO,KAAK,CAAA;AACd,CAAC;AAEM,KAAK,UAAU,wBAAwB,CAC5C,WAAgC,EAChC,WAA8B;IAE9B,6CAA6C;IAC7C,MAAM,aAAa,GAAG,IAAI,sBAAa,CAAC,WAAW,CAAC,CAAA;IACpD,MAAM,aAAa,CAAC,eAAe,CAAC,aAAa,EAAE,gBAAY,EAAE,WAAW,CAAC,CAAA;IAC7E,OAAO,aAAa,CAAA;AACtB,CAAC;AAEM,KAAK,UAAU,wBAAwB,CAC5C,WAA8B;IAE9B,6CAA6C;IAC7C,OAAO,IAAI,sBAAa,CAAC,WAAW,CAAC,CAAA;AACvC,CAAC;AAEM,KAAK,UAAU,wBAAwB,CAC5C,aAAgC,EAChC,WAA8B;IAE9B,MAAM,aAAa,GAAG,IAAI,sBAAa,CAAC,WAAW,CAAC,CAAA;IAEpD,MAAM,aAAa,CAAC,eAAe,CACjC,aAAa,EACb,iBAAa,EACb,aAAa,CAAC,OAAO,CAAC,OAAO,CAC9B,CAAA;IACD,MAAM,aAAa,CAAC,eAAe,CACjC,aAAa,EACb,gBAAY,EACZ,aAAa,CAAC,OAAO,CACtB,CAAA;IACD,MAAM,aAAa,CAAC,eAAe,CACjC,aAAa,EACb,kBAAc,EACd,aAAa,CAAC,OAAO,CACtB,CAAA;IAED,IAAI,aAAa,CAAC,OAAO,EAAE,CAAC;QAC1B,KAAK,MAAM,SAAS,IAAI,aAAa,CAAC,OAAO,CAAC,UAAU,EAAE,CAAC;YACzD,MAAM,MAAM,GAAG,MAAM,UAAU,CAAC,SAAS,EAAE,WAAW,CAAC,GAAG,CAAC,CAAA;YAC3D,MAAM,aAAa,CAAC,eAAe,CACjC,aAAa,EACb,MAAM,EACN,aAAa,CAAC,OAAO,CAAC,OAAO,EAC7B,SAAS,CACV,CAAA;QACH,CAAC;IACH,CAAC;IAED,OAAO,aAAa,CAAA;AACtB,CAAC","sourcesContent":["import { pathToFileURL } from 'node:url'\nimport path from 'node:path'\nimport { UsableEnvironment } from '../environment'\nimport filterPlugin from '../filter'\nimport { PluginManager, Plugin } from '../plugin'\nimport publishPlugin from '../publish'\nimport shardingPlugin from '../sharding'\nimport { doesNotHaveValue } from '../value_checker'\nimport { IRunConfiguration, ISourcesCoordinates } from './types'\n\nasync function importPlugin(specifier: string, cwd: string): Promise<any> {\n  try {\n    let normalized: URL | string = specifier\n    if (specifier.startsWith('.')) {\n      normalized = pathToFileURL(path.resolve(cwd, specifier))\n    } else if (specifier.startsWith('file://')) {\n      normalized = new URL(specifier)\n    }\n    return await import(normalized.toString())\n  } catch (e) {\n    throw new Error(`Failed to import plugin ${specifier}`, {\n      cause: e,\n    })\n  }\n}\n\nfunction findPlugin(imported: any): Plugin | null {\n  return findPluginRecursive(imported, 3)\n}\n\nfunction findPluginRecursive(thing: any, depth: number): Plugin | null {\n  if (doesNotHaveValue(thing)) {\n    return null\n  }\n  if (typeof thing === 'object' && thing.type === 'plugin') {\n    return thing\n  }\n  depth--\n  if (depth > 0) {\n    return findPluginRecursive(thing.default, depth)\n  }\n  return null\n}\n\nasync function loadPlugin(specifier: string, cwd: string): Promise<Plugin> {\n  const imported = await importPlugin(specifier, cwd)\n  const found = findPlugin(imported)\n  if (!found) {\n    throw new Error(`${specifier} does not export a plugin`)\n  }\n  return found\n}\n\nexport async function initializeForLoadSources(\n  coordinates: ISourcesCoordinates,\n  environment: UsableEnvironment\n): Promise<PluginManager> {\n  // eventually we'll load plugin packages here\n  const pluginManager = new PluginManager(environment)\n  await pluginManager.initCoordinator('loadSources', filterPlugin, coordinates)\n  return pluginManager\n}\n\nexport async function initializeForLoadSupport(\n  environment: UsableEnvironment\n): Promise<PluginManager> {\n  // eventually we'll load plugin packages here\n  return new PluginManager(environment)\n}\n\nexport async function initializeForRunCucumber(\n  configuration: IRunConfiguration,\n  environment: UsableEnvironment\n): Promise<PluginManager> {\n  const pluginManager = new PluginManager(environment)\n\n  await pluginManager.initCoordinator(\n    'runCucumber',\n    publishPlugin,\n    configuration.formats.publish\n  )\n  await pluginManager.initCoordinator(\n    'runCucumber',\n    filterPlugin,\n    configuration.sources\n  )\n  await pluginManager.initCoordinator(\n    'runCucumber',\n    shardingPlugin,\n    configuration.sources\n  )\n\n  if (configuration.plugins) {\n    for (const specifier of configuration.plugins.specifiers) {\n      const plugin = await loadPlugin(specifier, environment.cwd)\n      await pluginManager.initCoordinator(\n        'runCucumber',\n        plugin,\n        configuration.plugins.options,\n        specifier\n      )\n    }\n  }\n\n  return pluginManager\n}\n"]}