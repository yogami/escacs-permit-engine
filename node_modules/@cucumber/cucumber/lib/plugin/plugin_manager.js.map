{"version":3,"file":"plugin_manager.js","sourceRoot":"","sources":["../../src/plugin/plugin_manager.ts"],"names":[],"mappings":"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","sourcesContent":["import { UsableEnvironment } from '../environment'\nimport {\n  CoordinatorEventHandler,\n  CoordinatorEventKey,\n  CoordinatorEventValues,\n  CoordinatorTransformer,\n  CoordinatorTransformKey,\n  CoordinatorTransformValues,\n  FormatterPlugin,\n  Plugin,\n  PluginCleanup,\n  PluginOperation,\n} from './types'\n\ntype SourcedEventHandler<K extends CoordinatorEventKey> = {\n  handler: CoordinatorEventHandler<K>\n  specifier?: string\n}\n\ntype SourcedTransformer<K extends CoordinatorTransformKey> = {\n  transformer: CoordinatorTransformer<K>\n  specifier?: string\n}\n\ntype SourcedCleanup = {\n  cleanupFn: PluginCleanup\n  specifier?: string\n}\n\ntype HandlerRegistry = {\n  [K in CoordinatorEventKey]: Array<SourcedEventHandler<K>>\n}\n\ntype TransformerRegistry = {\n  [K in CoordinatorTransformKey]: Array<SourcedTransformer<K>>\n}\n\nexport class PluginManager {\n  private readonly handlers: HandlerRegistry = {\n    message: [],\n    'paths:resolve': [],\n  }\n  private readonly transformers: TransformerRegistry = {\n    'pickles:filter': [],\n    'pickles:order': [],\n  }\n  private cleanupFns: SourcedCleanup[] = []\n\n  constructor(private readonly environment: UsableEnvironment) {}\n\n  private async registerHandler<K extends CoordinatorEventKey>(\n    event: K,\n    handler: CoordinatorEventHandler<K>,\n    specifier?: string\n  ) {\n    if (!this.handlers[event]) {\n      throw new Error(`Cannot register handler for unknown event \"${event}\"`)\n    }\n    this.handlers[event].push({\n      handler,\n      specifier,\n    })\n  }\n\n  private async registerTransformer<K extends CoordinatorTransformKey>(\n    event: K,\n    transformer: CoordinatorTransformer<K>,\n    specifier?: string\n  ) {\n    if (!this.transformers[event]) {\n      throw new Error(\n        `Cannot register transformer for unknown event \"${event}\"`\n      )\n    }\n    this.transformers[event].push({\n      transformer,\n      specifier,\n    })\n  }\n\n  async initFormatter<OptionsType>(\n    plugin: FormatterPlugin<OptionsType>,\n    options: OptionsType,\n    stream: NodeJS.WritableStream,\n    write: (buffer: string | Uint8Array) => void,\n    directory?: string,\n    specifier?: string\n  ) {\n    const cleanupFn = await plugin.formatter({\n      on: (key, handler) => this.registerHandler(key, handler, specifier),\n      options: plugin.optionsKey\n        ? ((options as any)[plugin.optionsKey] ?? ({} as OptionsType))\n        : options,\n      logger: this.environment.logger,\n      stream,\n      write,\n      directory,\n    })\n    if (typeof cleanupFn === 'function') {\n      this.cleanupFns.push({\n        cleanupFn: cleanupFn,\n        specifier,\n      })\n    }\n  }\n\n  async initCoordinator<OptionsType>(\n    operation: PluginOperation,\n    plugin: Plugin<OptionsType>,\n    options: OptionsType,\n    specifier?: string\n  ) {\n    const context = {\n      operation,\n      on: <K extends CoordinatorEventKey>(\n        event: K,\n        handler: CoordinatorEventHandler<K>\n      ) => this.registerHandler(event, handler, specifier),\n      transform: <K extends CoordinatorTransformKey>(\n        event: K,\n        transformer: CoordinatorTransformer<K>\n      ) => this.registerTransformer(event, transformer, specifier),\n      options:\n        'optionsKey' in plugin && plugin.optionsKey\n          ? ((options as any)[plugin.optionsKey] ?? ({} as OptionsType))\n          : options,\n      logger: this.environment.logger,\n      environment: {\n        cwd: this.environment.cwd,\n        stderr: this.environment.stderr,\n        env: { ...this.environment.env },\n      },\n    }\n    const cleanupFn = await wrapErrorAsync(\n      async () => await plugin.coordinator(context),\n      specifier,\n      `Plugin \"${specifier}\" errored when trying to init`\n    )\n    if (typeof cleanupFn === 'function') {\n      this.cleanupFns.push({\n        cleanupFn: cleanupFn,\n        specifier,\n      })\n    }\n  }\n\n  emit<K extends CoordinatorEventKey>(\n    event: K,\n    value: CoordinatorEventValues[K]\n  ): void {\n    this.handlers[event].forEach(({ handler, specifier }) => {\n      wrapError(\n        () => handler(value),\n        specifier,\n        `Plugin \"${specifier}\" errored when trying to handle a \"${event}\" event`\n      )\n    })\n  }\n\n  async transform<K extends CoordinatorTransformKey>(\n    event: K,\n    value: CoordinatorTransformValues[K]\n  ): Promise<CoordinatorTransformValues[K]> {\n    let transformed = value\n    for (const { transformer, specifier } of this.transformers[event]) {\n      const returned = await wrapErrorAsync(\n        async () => await transformer(transformed),\n        specifier,\n        `Plugin \"${specifier}\" errored when trying to do a \"${event}\" transform`\n      )\n      if (typeof returned !== 'undefined') {\n        transformed = returned\n      }\n    }\n    return transformed\n  }\n\n  async cleanup(): Promise<void> {\n    for (const { cleanupFn, specifier } of this.cleanupFns) {\n      await wrapErrorAsync(\n        async () => await cleanupFn(),\n        specifier,\n        `Plugin \"${specifier}\" errored when trying to cleanup`\n      )\n    }\n  }\n}\n\nfunction wrapError<T>(fn: () => T, specifier: string, message: string): T {\n  try {\n    return fn()\n  } catch (error) {\n    if (specifier) {\n      throw new Error(message, { cause: error })\n    }\n    throw error\n  }\n}\n\nasync function wrapErrorAsync<T>(\n  fn: () => Promise<T>,\n  specifier: string,\n  message: string\n): Promise<T> {\n  try {\n    return await fn()\n  } catch (error) {\n    if (specifier) {\n      throw new Error(message, { cause: error })\n    }\n    throw error\n  }\n}\n"]}